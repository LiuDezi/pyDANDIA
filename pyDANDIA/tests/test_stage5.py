import numpy as np
import mock
import pytest
import os
from os import getcwd, path
from sys import path as systempath
import collections
from astropy.io import fits

cwd = getcwd()
systempath.append(path.join(cwd, '../'))
from umatrix_routine import umatrix_construction
import stage5
import metadata
import numpy as np


def test_umatrix_constant():
    setup = mock.MagicMock()
  
    reference_image = np.zeros((15, 15))                                  
    reference_image[7, 7] = 1                                             
    reference_image[8, 8] = 2                                       
    reference_image[9,9] = 1                                              
    u_matrix = stage5.umatrix_constant(reference_image, 5)        
    expected  = np.array([[   6.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,
           0.,    0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    1.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    1.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,
           4.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,
           0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,    1.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   4.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,
           0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,
           1.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,
           0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,
           0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,
           0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,
           6.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    1.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,
           0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    1.,    0.,    4.],
       [   1.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,
           0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,
           4.,    0.,    0.,    0.,    0.,    0.,    1.,    4.],
       [   0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,
           0.,    4.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,
           0.,    0.,    0.,    4.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,
           0.,    0.,    0.,    0.,    4.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    1.,    0.,    0.,    0.,
           0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,
           0.,    0.,    0.,    0.,    0.,    4.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    1.,    0.,    0.,
           0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,
           6.,    0.,    0.,    0.,    0.,    0.,    4.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    1.,    0.,
           0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,
           0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    6.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,
           0.,    0.,    0.,    6.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    6.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    6.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,
           4.,    0.,    0.,    0.,    0.,    0.,    6.,    4.],
       [   4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,
           4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,
           4.,    4.,    4.,    4.,    4.,    4.,    4.,  225.]])


    assert np.allclose(u_matrix,expected)



def test_bvector_constant():
    setup = mock.MagicMock()
  
    reference_image = np.zeros((15, 15))                                  
    reference_image[7, 7] = 1                                             
    reference_image[8, 8] = 2                                       
    reference_image[9,9] = 1                                              
    data_image = np.zeros((15, 15))                                                                                             
    data_image[8,8] =  1              
    bvector = stage5.bvector_constant(reference_image,data_image, 5)      
    expected  = np.array([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 2.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0])

    assert np.allclose(bvector,expected)

def test_noise_model():
    model = np.ones((5,5))*0.123
    gain = 1
    rno = 2.
    w = stage5.noise_model(model,gain,rno)
    expected = np.array([[ 0.249058  ,0.249058  ,0.249058  ,0.249058  ,0.249058],
                         [ 0.249058  ,0.249058  ,0.249058  ,0.249058  ,0.249058],
                         [ 0.249058  ,0.249058  ,0.249058  ,0.249058  ,0.249058],
                         [ 0.249058  ,0.249058  ,0.249058  ,0.249058  ,0.249058],
                         [ 0.249058  ,0.249058  ,0.249058  ,0.249058  ,0.249058]])

    assert np.allclose(w, expected)


def test_kernel_preparation_matrix():
    reference_image = np.zeros((15, 15))                                  
    reference_image[7, 7] = 1                                             
    reference_image[8, 8] = 2                                       
    reference_image[9,9] = 1                                              
    data_image = np.zeros((15, 15))                                                                                             
    data_image[8,8] =  1              
    umatrix, bvector =  stage5.kernel_preparation_matrix(data_image, reference_image, 5)      
    expected_b  = np.array([0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0,
                            0.0, 0.0, 2.0, 0.0, 0.0, 0.0, 0.0, 0.0, 1.0, 0.0,
                            0.0, 0.0, 0.0, 0.0, 0.0, 1.0])
    expected_u  = np.array([[   6.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,
           0.,    0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    1.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    1.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,
           4.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,
           0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,    1.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   4.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,
           0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,
           1.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,
           0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,
           0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,
           0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,
           6.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    1.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,
           0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    1.,    0.,    4.],
       [   1.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,
           0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,    0.,
           4.,    0.,    0.,    0.,    0.,    0.,    1.,    4.],
       [   0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,    0.,
           0.,    4.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,    0.,
           0.,    0.,    0.,    4.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,    0.,
           0.,    0.,    0.,    0.,    4.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    1.,    0.,    0.,    0.,
           0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,    6.,
           0.,    0.,    0.,    0.,    0.,    4.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    1.,    0.,    0.,
           0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,    0.,
           6.,    0.,    0.,    0.,    0.,    0.,    4.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    1.,    0.,
           0.,    0.,    0.,    0.,    4.,    0.,    0.,    0.,    0.,
           0.,    6.,    0.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    6.,    0.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,    0.,
           0.,    0.,    0.,    6.,    0.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,    0.,
           0.,    0.,    0.,    0.,    6.,    0.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,    4.,
           0.,    0.,    0.,    0.,    0.,    6.,    0.,    4.],
       [   0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,    0.,
           0.,    0.,    0.,    1.,    0.,    0.,    0.,    0.,    0.,
           4.,    0.,    0.,    0.,    0.,    0.,    6.,    4.],
       [   4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,
           4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,    4.,
           4.,    4.,    4.,    4.,    4.,    4.,    4.,  225.]])
    assert np.allclose(bvector,expected_b)
    assert np.allclose(umatrix,expected_u)

